
/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Delete Account IDs from Table T24_ACCOUNT_ID','S',getdate());
DELETE FROM dbo.T24_ACCOUNT_ID WHERE ACCOUNT_TYPE IN ('AA','AAD');
/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Delete Account IDs from Table T24_ACCOUNT_ID','F',getdate());

-----------------------------------------
-- Insert Branch 91 accounts
-----------------------------------------
/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Insert Urbis Accounts into Table T24_ACCOUNT_ID for Conv.','S',getdate());

INSERT INTO dbo.T24_ACCOUNT_ID (ID,[ACCOUNT_TYPE],ACCOUNT,CCY,BRANCH,REFERENCE_ID)
SELECT 
ROW_NUMBER() OVER (
ORDER BY CACCO.RACC_NO,CACCO.CCY,CACCO.BRANCH
) ID,
'AA' ACCOUNT_TYPE, CACCO.RACC_NO ACCOUNT, CACCO.CCY, SUBSTRING(CACCO.BRANCH,1,2) BRANCH, NULL AS REFERENCE_ID
FROM 
[UrbisCbsRrLink].[URBNEODBABC].URBIS.CACCO  CACCO 
	LEFT JOIN [UrbisCbsRrLink].[URBNEODBABC].URBIS.CASTM  CASTM 
		ON 	  CACCO.RACC_NO = CASTM.ACCOUNT AND CACCO.CCY = CASTM.CCY
	LEFT JOIN [UrbisCbsRrLink].[URBNEODBABC].URBIS.RACLX RACLX
		ON 	  CACCO.RACC_NO = RACLX.RACC_NO AND CACCO.CCY = RACLX.CCY
WHERE
CASTM.GLACC_CR IN ('2011201','2011203','2011204','2011202','2011205','2011601','2011603','2011604','2011251','2011253','2011254') AND 
CACCO.RACC_NO = CASTM.ACCOUNT AND
CACCO.CCY = CASTM.CCY AND
CACCO.STATUS_CDE IN 
(
1,  -- Active
5  -- Dormant
)
AND	  RACLX.CLIENT_NO IN (SELECT [CUSTOMER.CODE] FROM [dbo].[V_T24_CUSTOMERS_ALL]) 
AND   CACCO.START_DN < 25109  --20250930 
AND  SUBSTRING(CACCO.BRANCH,1,2) = '91'

/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Insert Urbis Accounts into Table T24_ACCOUNT_ID for Conv.','F',getdate());

-----------------------------------------
-- Insert Branch 96 accounts
-----------------------------------------
/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Insert Urbis Accounts into Table T24_ACCOUNT_ID for Islamic','S',getdate());

INSERT INTO dbo.T24_ACCOUNT_ID (ID,[ACCOUNT_TYPE],ACCOUNT,CCY,BRANCH,REFERENCE_ID)
SELECT 
ROW_NUMBER() OVER (
ORDER BY CACCO.RACC_NO,CACCO.CCY,CACCO.BRANCH
) ID,
'AA' ACCOUNT_TYPE, CACCO.RACC_NO ACCOUNT, CACCO.CCY, SUBSTRING(CACCO.BRANCH,1,2) BRANCH, NULL AS REFERENCE_ID
FROM 
[UrbisCbsRrLink].[URBNEODBABC].URBIS.CACCO  CACCO 
	LEFT JOIN [UrbisCbsRrLink].[URBNEODBABC].URBIS.CASTM  CASTM 
		ON 	  CACCO.RACC_NO = CASTM.ACCOUNT AND CACCO.CCY = CASTM.CCY
	LEFT JOIN [UrbisCbsRrLink].[URBNEODBABC].URBIS.RACLX RACLX
		ON 	  CACCO.RACC_NO = RACLX.RACC_NO AND CACCO.CCY = RACLX.CCY
WHERE
CASTM.GLACC_CR IN ('2011201','2011203','2011204','2011202','2011205','2011601','2011603','2011604','2011251','2011253','2011254') AND 
CACCO.RACC_NO = CASTM.ACCOUNT AND
CACCO.CCY = CASTM.CCY AND
CACCO.STATUS_CDE IN 
(
1,  -- Active
5  -- Dormant
)
AND	  RACLX.CLIENT_NO IN (SELECT [CUSTOMER.CODE] FROM [dbo].[V_T24_CUSTOMERS_ALL]) 
AND   CACCO.START_DN < 25109  --20250930 
AND  SUBSTRING(CACCO.BRANCH,1,2) = '96'

/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Insert Urbis Accounts into Table T24_ACCOUNT_ID for Islamic','F',getdate());
-----------------------------------------
-----------------------------------------
--generating IDs for Islamic accounts

/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Generate T24 Account IDs into Table T24_GENERATED_ID for Islamic','S',getdate());

DECLARE @RC int
DECLARE @Luhn varchar(7999)
DECLARE @branch varchar(10)
DECLARE @acc_type varchar(10)

SELECT @Luhn = CASE WHEN SUBSTRING(MAX(CAST(REFERENCE_ID AS varchar)),1,9) IS NULL THEN '300006445'
						ELSE 	SUBSTRING(MAX(CAST(REFERENCE_ID AS varchar)),1,9) + 1 END 
						FROM [dbo].[T24_ACCOUNT_ID] WHERE REFERENCE_ID LIKE '3%'
SET @branch = '96'
SET @acc_type = 'AA'

EXECUTE @RC = [dbo].[GENERATE_REF_ID] 
   @Luhn
  ,@branch
  ,@acc_type
GO

/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Generate T24 Account IDs into Table T24_GENERATED_ID for Islamic','F',getdate());
----------------------------------------
--generating IDs for Conventional accounts
----------------------------------------

/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Generate T24 Account IDs into Table T24_GENERATED_ID for Conv.','S',getdate());

DECLARE @RC int
DECLARE @Luhn varchar(7999)
DECLARE @branch varchar(10)
DECLARE @acc_type varchar(10)

SELECT @Luhn = CASE WHEN SUBSTRING(MAX(CAST(REFERENCE_ID AS varchar)),1,9) IS NULL THEN '200051559'
						ELSE 	SUBSTRING(MAX(CAST(REFERENCE_ID AS varchar)),1,9) + 1 END 
						FROM [dbo].[T24_ACCOUNT_ID] WHERE REFERENCE_ID LIKE '2%'
SET @branch = '91'
SET @acc_type = 'AA'

EXECUTE @RC = [dbo].[GENERATE_REF_ID] 
   @Luhn
  ,@branch
  ,@acc_type
GO

/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Generate T24 Account IDs into Table T24_GENERATED_ID for Conv.','F',getdate());

--------------------------------------------
-- Update Ids for Islamic accounts
----------------------------------------
/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Update T24 Account IDs in Table T24_ACCOUNT_ID from Table T24_GENERATED_ID for Islamic','S',getdate());

	UPDATE X
	SET X.REFERENCE_ID = S.REF_NO
	FROM dbo.T24_ACCOUNT_ID X,
	dbo.T24_GENERATED_ID S
	WHERE X.ID = S.ID
	AND X.[ACCOUNT_TYPE] = S.[ACCOUNT_TYPE]
	AND X.REFERENCE_ID IS NULL
	AND X.BRANCH = S.BRANCH
	AND X.ACCOUNT_TYPE = 'AA'
	AND X.BRANCH = '96';
	
/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Update T24 Account IDs in Table T24_ACCOUNT_ID from Table T24_GENERATED_ID for Islamic','F',getdate());
--------------------------------------------
-- Update Ids for Conventional accounts
----------------------------------------
/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Update T24 Account IDs in Table T24_ACCOUNT_ID from Table T24_GENERATED_ID for Conv.','S',getdate());
	UPDATE X
	SET X.REFERENCE_ID = S.REF_NO
	FROM dbo.T24_ACCOUNT_ID X,
	dbo.T24_GENERATED_ID S
	WHERE X.ID = S.ID
	AND X.[ACCOUNT_TYPE] = S.[ACCOUNT_TYPE]
	AND X.REFERENCE_ID IS NULL
	AND X.BRANCH = S.BRANCH
	AND X.ACCOUNT_TYPE = 'AA'
	AND X.BRANCH = '91';
	
/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Update T24 Account IDs in Table T24_ACCOUNT_ID from Table T24_GENERATED_ID for Conv.','F',getdate());
--------------------------------------------

/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Generate account dormancy status into toble dbo.T24_ACC_LAST_DORMANCY','S',getdate());
EXEC GENERATE_ACC_DORMANCY_STATUS 25109  --20251002
/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Generate account dormancy status into toble dbo.T24_ACC_LAST_DORMANCY','F',getdate());

------------------------------------------------------------

/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Populate the data into toble T24_AAA','S',getdate());

IF OBJECT_ID ('dbo.T24_AAA', 'table') IS NOT NULL
   DROP TABLE dbo.T24_AAA ;
GO

SELECT
NULL AS 'HEADER_NO',
CACCO.RACC_NO AS 'ACCOUNT_NO',
CASE SUBSTRING(CACCO.BRANCH,1,2) WHEN '96' THEN 'BH0030096' ELSE 'BH0020091' END AS 'UPLOAD.COMPANY',
NULL AS 'ID_ARR.SEQUENCE',
'NEW' AS 'ARRANGEMENT',
'ACCOUNTS-TAKEOVER-ARRANGEMENT' AS 'ACTIVITY',
'20250930' AS 'EFFECTIVE.DATE',
RACLX.CLIENT_NO AS 'CUSTOMER',
NULL AS 'CUSTOMER.ROLE',
NULL AS 'TRADE.DATE',
NULL AS 'ALTERNATE.ID',
NULL AS 'REMARKS',
NULL AS 'ARRANGEMENT.LINK.TYPE',
NULL AS 'MASTER.ARRANGEMENT',
PROD.T24_PRODUCT AS 'PRODUCT',
CACCO.CCY AS 'CURRENCY',
NULL AS 'CHANNEL',
NULL AS 'ARR.COMPANY.CODE',
NULL AS 'BRANCH',
NULL AS 'LINE.OF.BUSINESS',
NULL AS 'LINKED.ACTIVITY',
NULL AS 'INITIATION.TYPE',
NULL AS 'SECONDARY.TYPE',
CONVERT(VARCHAR,[URBNEODBABC].REPORT.REL_DAY_TO_DATE(CACCO.START_DN),112) AS 'ORIG.CONTRACT.DATE',
NULL AS 'MASTER.AAA',
NULL AS 'REV.MASTER.AAA',
NULL AS 'ADJUSTMENT',
NULL AS 'TXN.AMOUNT',
NULL AS 'TXN.AMOUNT.LCY',
NULL AS 'TXN.EXCH.RATE',
NULL AS 'TXN.CONTRACT.ID',
NULL AS 'TXN.SYSTEM.ID',
NULL AS 'EXPOSURE.DATE',
NULL AS 'LOCAL.REF',
CONCAT('BALANCE::OFFICERS',
CASE WHEN CASTM.INT_CODE IN ('0','1','3','5','7')  AND CASTM.GLACC_CR NOT IN ('2011251','2011253','2011254') THEN  -- Not AlKanz
			CASE SUBSTRING(CACCO.BRANCH,1,2) WHEN '91' THEN '::CRINTEREST' ELSE '' END
	ELSE '' END)
AS 'PROPERTY',
NULL AS 'EFFECTIVE',
CONCAT(
--'ACCOUNT.TITLE.1','!!',
--'ACCOUNT.TITLE.2','!!',
--'SHORT.TITLE','!!',
'ALT.ID:1','!!',
'ALT.ID:3','!!',
'ACCOUNT.REFERENCE','!!',
'POSTING.RESTRICT','::',
'PRIMARY.OFFICER',
CASE WHEN CASTM.INT_CODE IN ('0','1','3','5','7') AND CASTM.GLACC_CR NOT IN ('2011251','2011253','2011254') THEN 
		CASE SUBSTRING(CACCO.BRANCH,1,2) WHEN '91' THEN
			CASE WHEN CASTM.CCY IN ('BHD','USD') THEN '::FIXED.RATE:1!!FIXED.RATE:2' ELSE '::FIXED.RATE:1' END
			ELSE ''
		END
	ELSE '' 
END
) AS 'FIELD.NAME',
--[dbo].[F_RemoveNonASCII]([dbo].[fn_StripCharacters](CACCO.ACCNAME,'^A-Za-z0-9 /-:(),.''+?')) + '!!' + --ACCOUNT.TITLE.1
--CASE WHEN CACCO.ACCNAME LIKE '%[^A-Za-z0-9 -@._-/&+,:;$!?()]%' THEN 'TO.BE.CHANGED'  ELSE REPLACE(REPLACE(CACCO.ACCNAME,'_','''_'''),'!','') END + '!!' + --ACCOUNT.TITLE.1
--'' + '!!' + --ACCOUNT.TITLE.1
--'' + '!!' + --ACCOUNT.TITLE.2
--GLADO.ACCNAME + '!!' + --SHORT.TITLE
--'' + '!!' + --SHORT.TITLE
CONCAT(CACCO.RACC_NO, CACCO.CCY) + '!!' + --ALT.ID:1
CASTM.IBAN + '!!' + --ALT.ID:3
ISNULL(CONVERT(VARCHAR,T.REFERENCE_ID),'') + '!!' + --ACCOUNT.REFERENCE
'' + '::' + --POSTING.RESTRICT
----OFFICER------
'347001001' + --PRIMARY.OFFICER 
----CRINTEREST/CRPROFIT------
CASE WHEN SUBSTRING(CACCO.BRANCH,1,2) = '91' THEN
	CASE WHEN CASTM.INT_CODE IN ('1','3','5','7')  THEN 
				'::' + 	CASE WHEN CASTM.CCY IN ('BHD','USD') 
								THEN ISNULL(CONVERT(VARCHAR,CAST(INTSO.RATE1 AS float)),'') + '!!' + ISNULL(CONVERT(VARCHAR,CAST(INTSO.RATE1 AS float)),'')
							ELSE
								ISNULL(CONVERT(VARCHAR,CAST(INTSO.RATE1 AS float)),'') 
							END
				WHEN CASTM.INT_CODE IN ('0') AND CASTM.GLACC_CR NOT IN ('2011251','2011253','2011254') THEN 
					'::' + CASE WHEN CASTM.CCY IN ('BHD','USD') 
								THEN '0!!0'
							ELSE
								'0'	
							END
				ELSE '' 
	END
ELSE ''
END
AS 'FIELD.VALUE',
CONCAT(
'LAST.ACTIVE.TRANSACTION.DATE','::',
'LAST.DORMANCY.DATE','::',
'LAST.DORMANCY.STATUS'
) AS 'CONTEXT.NAME',
--CASE WHEN CACCO.LST_MVT_DTE_RDN IS NULL THEN '' ELSE CONVERT(VARCHAR,[URBNEODBABC].REPORT.REL_DAY_TO_DATE(CACCO.LST_MVT_DTE_RDN),112) END + '::' + --LAST.ACTIVE.TRANSACTION.DATE
--CASE WHEN CACCO.LST_MVT_DTE_RDN IS NULL OR CACCO.LST_MVT_DTE_RDN = 0 THEN CONVERT(VARCHAR,[URBNEODBABC].REPORT.REL_DAY_TO_DATE(CACCO.START_DN),112) ELSE CONVERT(VARCHAR,[URBNEODBABC].REPORT.REL_DAY_TO_DATE(CACCO.LST_MVT_DTE_RDN),112) END + '::' + --LAST.ACTIVE.TRANSACTION.DATE
DRM.MAX_TRANS_DATE + '::' + --LAST.ACTIVE.TRANSACTION.DATE
DRM.UPDATED_LAST_DORMANCY_DATE + '::' + --LAST.DORMANCY.DATE
--CASTM.BLOCK_CODE  --LAST.DORMANCY.DATE 
DRM.UPDATED_LAST_DORMANCY_STATUS --LAST.DORMANCY.STATUS 
AS 'CONTEXT.VALUE',
NULL AS 'TRANS.CUSTOMER',
NULL AS 'SIGNATORY',
NULL AS 'SIM.RUN.REF',
NULL AS 'ORIG.TXN.AMT',
NULL AS 'ORIG.TXN.AMT.LCY',
NULL AS 'GB NARRATIVE',
NULL AS 'EXT.EVENT.REF',
NULL AS 'PRODUCT.VARIATION',
NULL AS 'PRICING.SELECTION',
NULL AS 'PRICING.PLAN',
NULL AS 'REASON',
NULL AS 'EVENT.ID',
NULL AS 'AGENT.ID',
NULL AS 'AGENT.ARR.ID',
NULL AS 'AGENT.ROLE',
NULL AS 'REWARDS.ARR.ID',
NULL AS 'CLOSURE.REASON',
NULL AS 'CLOSURE.NOTES',
NULL AS 'CR.OPPORTUNITY',
NULL AS 'ACTIVITY.LINK.TYPE',
NULL AS 'LINKED.PARENT.REF',
----------------------------- Static Fields --------------------------------
--CASE WHEN CACCO.ACCNAME LIKE '%[^A-Za-z0-9 -_@.-/&+,:;$!?()]%' THEN 'TO.BE.CHANGED'  ELSE REPLACE(REPLACE(CACCO.ACCNAME,'_','''_'''),'!','') END  [ACCOUNT.TITLE.1],
--''  [ACCOUNT.TITLE.1],
--GLADO.ACCNAME [SHORT.TITLE],
--'' [SHORT.TITLE],
CONCAT(CACCO.RACC_NO, CACCO.CCY) [ALT.ID:1],
CASTM.IBAN [ALT.ID:3],
ISNULL(CONVERT(VARCHAR,T.REFERENCE_ID),'') [ACCOUNT.REFERENCE],
'347001001' [PRIMARY.OFFICER ],
CASE WHEN SUBSTRING(CACCO.BRANCH,1,2) = '91' THEN
	CASE WHEN CASTM.INT_CODE IN ('1','3','5','7')  THEN 
			ISNULL(CONVERT(VARCHAR,CAST(INTSO.RATE1 AS float)),'') 
			WHEN CASTM.INT_CODE IN ('0') AND CASTM.GLACC_CR NOT IN ('2011251','2011253','2011254') THEN 
			'0'	
	END
ELSE ''
END
AS 'INT_RATE',
--CASE WHEN CACCO.LST_MVT_DTE_RDN IS NULL OR CACCO.LST_MVT_DTE_RDN = 0 THEN CONVERT(VARCHAR,[URBNEODBABC].REPORT.REL_DAY_TO_DATE(CACCO.START_DN),112) ELSE CONVERT(VARCHAR,[URBNEODBABC].REPORT.REL_DAY_TO_DATE(CACCO.LST_MVT_DTE_RDN),112) END [LAST.ACTIVE.TRANSACTION.DATE],
DRM.MAX_TRANS_DATE [LAST.ACTIVE.TRANSACTION.DATE],
DRM.UPDATED_LAST_DORMANCY_DATE AS [LAST.DORMANCY.DATE],
DRM.UPDATED_LAST_DORMANCY_STATUS AS [LAST.DORMANCY.STATUS]
----------------------------- Static Fields --------------------------------
INTO dbo.T24_AAA
      FROM 
	  [UrbisCbsRrLink].[URBNEODBABC].URBIS.RACLX AS RACLX,
	  [UrbisCbsRrLink].[URBNEODBABC].URBIS.CASTM AS CASTM LEFT OUTER JOIN dbo.V_T24_PRODUCT_MAPPINGS PROD ON CASTM.GLACC_CR = PROD.URBIS_PRODUCT COLLATE SQL_Latin1_General_CP1_CI_AS,
	  [UrbisCbsRrLink].[URBNEODBABC].URBIS.CACCO AS CACCO --LEFT OUTER JOIN REPORT.T24_LAST_MOVE POST ON CACCO.RACC_NO = POST.ACCOUNT AND CACCO.CCY = POST.CCY
	  LEFT OUTER JOIN [UrbisCbsRrLink].[URBNEODBABC].URBIS.INTSO INTSO ON CACCO.RACC_NO = INTSO.ACCOUNT AND CACCO.CCY = INTSO.CCY
		AND INTSO.REL_DAY = (SELECT MAX(REL_DAY) FROM [UrbisCbsRrLink].[URBNEODBABC].URBIS.INTSO WHERE CACCO.RACC_NO = ACCOUNT AND CACCO.CCY = CCY AND REL_DAY < 25109)
	  LEFT JOIN dbo.T24_ACCOUNT_ID T ON T.ACCOUNT = CACCO.RACC_NO AND T.CCY = CACCO.CCY AND T.ACCOUNT_TYPE = 'AA'
	  LEFT OUTER JOIN dbo.T24_ACC_LAST_DORMANCY DRM ON DRM.URBIS_ACCOUNT = CACCO.RACC_NO AND DRM.CCY = CACCO.CCY,
	  [UrbisCbsRrLink].[URBNEODBABC].URBIS.GLADO AS GLADO
      WHERE 
	  --CASTM.GLACC_CR IN ('2011201','2011203','2011204','2011202','2011604','2011251','2011253','2011254')
	  CASTM.GLACC_CR IN ('2011201','2011203','2011204','2011202','2011205','2011601','2011603','2011604','2011251','2011253','2011254')
      	AND  CACCO.RACC_NO = CASTM.ACCOUNT AND
	  CACCO.CCY = CASTM.CCY AND
	  CACCO.RACC_NO = RACLX.RACC_NO AND
	  CACCO.CCY = RACLX.CCY AND
	  CASTM.GLACC_CR = GLADO.GLAC_STUB AND 
	  CACCO.RACC_NO = CASTM.ACCOUNT AND
	  CACCO.CCY = CASTM.CCY AND
	  CACCO.STATUS_CDE IN 
	  (
	  1,  -- Active
	  5  -- Dormant
	  )
	  AND	  RACLX.CLIENT_NO IN (SELECT [CUSTOMER.CODE] FROM [dbo].[V_T24_CUSTOMERS_ALL]) 
	  AND   CACCO.START_DN < 25109  --20250930 
	  
	  
	  
GO

CREATE UNIQUE INDEX INDX1
ON dbo.T24_AAA (ACCOUNT_NO,CURRENCY);
GO

/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Populate the data into toble T24_AAA','F',getdate());

IF OBJECT_ID ('dbo.T24_AAA_HEADERS', 'table') IS NOT NULL
   DROP TABLE dbo.T24_AAA_HEADERS ;
GO

SELECT * INTO  dbo.T24_AAA_HEADERS 
FROM(
SELECT 
'1' AS 'HEADER_NO',
'Extra' AS 'ACCOUNT_NO',
'Y' AS 'UPLOAD.COMPANY',
'Y' AS 'ID_ARR.SEQUENCE',
'Y' AS 'ARRANGEMENT',
'Y' AS 'ACTIVITY',
'Y' AS 'EFFECTIVE.DATE',
'Y' AS 'CUSTOMER',
'Y' AS 'CUSTOMER.ROLE',
'N' AS 'TRADE.DATE',
'N' AS 'ALTERNATE.ID',
'N' AS 'REMARKS',
'N' AS 'ARRANGEMENT.LINK.TYPE',
'N' AS 'MASTER.ARRANGEMENT',
'Y' AS 'PRODUCT',
'Y' AS 'CURRENCY',
'Y' AS 'CHANNEL',
'N' AS 'ARR.COMPANY.CODE',
'N' AS 'BRANCH',
'N' AS 'LINE.OF.BUSINESS',
'N' AS 'LINKED.ACTIVITY',
'N' AS 'INITIATION.TYPE',
'N' AS 'SECONDARY.TYPE',
'Y' AS 'ORIG.CONTRACT.DATE',
'N' AS 'MASTER.AAA',
'N' AS 'REV.MASTER.AAA',
'N' AS 'ADJUSTMENT',
'N' AS 'TXN.AMOUNT',
'N' AS 'TXN.AMOUNT.LCY',
'N' AS 'TXN.EXCH.RATE',
'N' AS 'TXN.CONTRACT.ID',
'N' AS 'TXN.SYSTEM.ID',
'N' AS 'EXPOSURE.DATE',
'N' AS 'LOCAL.REF',
'Y' AS 'PROPERTY',
'N' AS 'EFFECTIVE',
'Y' AS 'FIELD.NAME',
'Y' AS 'FIELD.VALUE',
'Y' AS 'CONTEXT.NAME',
'Y' AS 'CONTEXT.VALUE',
'N' AS 'TRANS.CUSTOMER',
'N' AS 'SIGNATORY',
'N' AS 'SIM.RUN.REF',
'N' AS 'ORIG.TXN.AMT',
'N' AS 'ORIG.TXN.AMT.LCY',
'N' AS 'GB NARRATIVE',
'N' AS 'EXT.EVENT.REF',
'N' AS 'PRODUCT.VARIATION',
'N' AS 'PRICING.SELECTION',
'N' AS 'PRICING.PLAN',
'N' AS 'REASON',
'N' AS 'EVENT.ID',
'N' AS 'AGENT.ID',
'N' AS 'AGENT.ARR.ID',
'N' AS 'AGENT.ROLE',
'N' AS 'REWARDS.ARR.ID',
'N' AS 'CLOSURE.REASON',
'N' AS 'CLOSURE.NOTES',
'N' AS 'CR.OPPORTUNITY',
'N' AS 'ACTIVITY.LINK.TYPE',
'N' AS 'LINKED.PARENT.REF'
UNION
SELECT
'2' ,
'CACCO.RACC_NO',
'CASE SUBSTRING(CACCO.BRANCH,1,2) WHEN 96 THEN BH0030096 ELSE BH0020091 END',
'Default',
'Default',
'Default',
'getdate',
'RACLX.CLIENT_NO',
'Default',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'CASTM.GLACC_CR',
'CACCO.CCY',
'Default',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'CACCO.START_DN',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Default',
'Not_Mapped',
'Default',
'CACCO.ACCNAME + !! + Not_Mapped + !! + GLADO.ACCNAME + !! + CONCAT(CACCO.RACC_NO, CACCO.CCY) + !! + CASTM.IBAN + !! +  Not_Mapped + !! + 1 :: INTSO.RATE1',
'Default',
'POST.MAX_INPUT_REL + :: + Not_Mapped + :: + CASTM.BLOCK_CODE',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped',
'Not_Mapped'
) AS TEMP;

GO

IF OBJECT_ID ('dbo.T24_AAA_DETAILED', 'table') IS NOT NULL
   DROP TABLE dbo.T24_AAA_DETAILED ;
GO

/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Create the table T24_AAA_DETAILED','S',getdate());

SELECT * INTO dbo.T24_AAA_DETAILED FROM
(
SELECT * FROM dbo.T24_AAA_HEADERS
UNION
SELECT
CAST([HEADER_NO] AS varchar(200))  AS 'HEADER_NO',
CAST([ACCOUNT_NO] AS varchar(200))  AS 'ACCOUNT_NO',
CAST([UPLOAD.COMPANY] AS varchar(200))  AS 'UPLOAD.COMPANY',
CAST([ID_ARR.SEQUENCE] AS varchar(200))  AS 'ID_ARR.SEQUENCE',
CAST([ARRANGEMENT] AS varchar(200))  AS 'ARRANGEMENT',
CAST([ACTIVITY] AS varchar(200))  AS 'ACTIVITY',
CAST([EFFECTIVE.DATE] AS varchar(200))  AS 'EFFECTIVE.DATE',
CAST([CUSTOMER] AS varchar(200))  AS 'CUSTOMER',
CAST([CUSTOMER.ROLE] AS varchar(200))  AS 'CUSTOMER.ROLE',
CAST([TRADE.DATE] AS varchar(200))  AS 'TRADE.DATE',
CAST([ALTERNATE.ID] AS varchar(200))  AS 'ALTERNATE.ID',
CAST([REMARKS] AS varchar(200))  AS 'REMARKS',
CAST([ARRANGEMENT.LINK.TYPE] AS varchar(200))  AS 'ARRANGEMENT.LINK.TYPE',
CAST([MASTER.ARRANGEMENT] AS varchar(200))  AS 'MASTER.ARRANGEMENT',
CAST([PRODUCT] AS varchar(200))  AS 'PRODUCT',
CAST([CURRENCY] AS varchar(200))  AS 'CURRENCY',
CAST([CHANNEL] AS varchar(200))  AS 'CHANNEL',
CAST([ARR.COMPANY.CODE] AS varchar(200))  AS 'ARR.COMPANY.CODE',
CAST([BRANCH] AS varchar(200))  AS 'BRANCH',
CAST([LINE.OF.BUSINESS] AS varchar(200))  AS 'LINE.OF.BUSINESS',
CAST([LINKED.ACTIVITY] AS varchar(200))  AS 'LINKED.ACTIVITY',
CAST([INITIATION.TYPE] AS varchar(200))  AS 'INITIATION.TYPE',
CAST([SECONDARY.TYPE] AS varchar(200))  AS 'SECONDARY.TYPE',
CAST([ORIG.CONTRACT.DATE] AS varchar(200))  AS 'ORIG.CONTRACT.DATE',
CAST([MASTER.AAA] AS varchar(200))  AS 'MASTER.AAA',
CAST([REV.MASTER.AAA] AS varchar(200))  AS 'REV.MASTER.AAA',
CAST([ADJUSTMENT] AS varchar(200))  AS 'ADJUSTMENT',
CAST([TXN.AMOUNT] AS varchar(200))  AS 'TXN.AMOUNT',
CAST([TXN.AMOUNT.LCY] AS varchar(200))  AS 'TXN.AMOUNT.LCY',
CAST([TXN.EXCH.RATE] AS varchar(200))  AS 'TXN.EXCH.RATE',
CAST([TXN.CONTRACT.ID] AS varchar(200))  AS 'TXN.CONTRACT.ID',
CAST([TXN.SYSTEM.ID] AS varchar(200))  AS 'TXN.SYSTEM.ID',
CAST([EXPOSURE.DATE] AS varchar(200))  AS 'EXPOSURE.DATE',
CAST([LOCAL.REF] AS varchar(200))  AS 'LOCAL.REF',
CAST([PROPERTY] AS varchar(200))  AS 'PROPERTY',
CAST([EFFECTIVE] AS varchar(200))  AS 'EFFECTIVE',
CAST([FIELD.NAME] AS varchar(200))  AS 'FIELD.NAME',
CAST([FIELD.VALUE] AS varchar(200))  AS 'FIELD.VALUE',
CAST([CONTEXT.NAME] AS varchar(200))  AS 'CONTEXT.NAME',
CAST([CONTEXT.VALUE] AS varchar(200))  AS 'CONTEXT.VALUE',
CAST([TRANS.CUSTOMER] AS varchar(200))  AS 'TRANS.CUSTOMER',
CAST([SIGNATORY] AS varchar(200))  AS 'SIGNATORY',
CAST([SIM.RUN.REF] AS varchar(200))  AS 'SIM.RUN.REF',
CAST([ORIG.TXN.AMT] AS varchar(200))  AS 'ORIG.TXN.AMT',
CAST([ORIG.TXN.AMT.LCY] AS varchar(200))  AS 'ORIG.TXN.AMT.LCY',
CAST([GB NARRATIVE] AS varchar(200))  AS 'GB NARRATIVE',
CAST([EXT.EVENT.REF] AS varchar(200))  AS 'EXT.EVENT.REF',
CAST([PRODUCT.VARIATION] AS varchar(200))  AS 'PRODUCT.VARIATION',
CAST([PRICING.SELECTION] AS varchar(200))  AS 'PRICING.SELECTION',
CAST([PRICING.PLAN] AS varchar(200))  AS 'PRICING.PLAN',
CAST([REASON] AS varchar(200))  AS 'REASON',
CAST([EVENT.ID] AS varchar(200))  AS 'EVENT.ID',
CAST([AGENT.ID] AS varchar(200))  AS 'AGENT.ID',
CAST([AGENT.ARR.ID] AS varchar(200))  AS 'AGENT.ARR.ID',
CAST([AGENT.ROLE] AS varchar(200))  AS 'AGENT.ROLE',
CAST([REWARDS.ARR.ID] AS varchar(200))  AS 'REWARDS.ARR.ID',
CAST([CLOSURE.REASON] AS varchar(200))  AS 'CLOSURE.REASON',
CAST([CLOSURE.NOTES] AS varchar(200))  AS 'CLOSURE.NOTES',
CAST([CR.OPPORTUNITY] AS varchar(200))  AS 'CR.OPPORTUNITY',
CAST([ACTIVITY.LINK.TYPE] AS varchar(200))  AS 'ACTIVITY.LINK.TYPE',
CAST([LINKED.PARENT.REF] AS varchar(200))  AS 'LINKED.PARENT.REF'
FROM dbo.T24_AAA
) AS TEMP;
GO
/* LOG */ INSERT INTO dbo.MIG_LOG (Application,Step,Sub_Step,Event,DateStamp) Values ('ACCOUNTS','Accounts Transformation','Create the table T24_AAA_DETAILED','F',getdate());

CREATE UNIQUE INDEX INDX1
ON dbo.T24_AAA_DETAILED (HEADER_NO,ACCOUNT_NO,CURRENCY);
GO